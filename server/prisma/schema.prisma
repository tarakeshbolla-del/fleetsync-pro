// Prisma Schema for FleetSync Pro
// Australian Fleet Management Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============

enum VehicleStatus {
  DRAFT
  AVAILABLE
  RENTED
  SUSPENDED
}

enum VevoStatus {
  PENDING
  APPROVED
  DENIED
  RESTRICTED
}

enum DriverStatus {
  PENDING_APPROVAL
  ACTIVE
  BLOCKED
  INACTIVE
}

enum RentalStatus {
  ACTIVE
  COMPLETED
  TERMINATED
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
}

enum AlertType {
  REGO_EXPIRY
  CTP_EXPIRY
  PINK_SLIP_EXPIRY
  VEVO_ISSUE
  PAYMENT_OVERDUE
}

enum UserRole {
  ADMIN
  DRIVER
}

// ============ MODELS ============

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(DRIVER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  driver Driver?
}

model Vehicle {
  id              String        @id @default(uuid())
  vin             String        @unique
  plate           String        @unique
  make            String
  model           String
  year            Int
  color           String
  status          VehicleStatus @default(DRAFT)

  // NSW Compliance Dates
  regoExpiry      DateTime      @map("rego_expiry")
  ctpExpiry       DateTime      @map("ctp_expiry")
  pinkSlipExpiry  DateTime      @map("pink_slip_expiry")

  // Financials
  weeklyRate      Decimal       @default(0) @db.Decimal(10, 2)
  bondAmount      Decimal       @default(0) @db.Decimal(10, 2)

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  rentals         Rental[]
  alerts          Alert[]

  @@map("vehicles")
}

model Driver {
  id              String       @id @default(uuid())
  userId          String?      @unique @map("user_id")
  name            String
  email           String       @unique
  phone           String?
  licenseNo       String       @unique @map("license_no")
  licenseExpiry   DateTime?    @map("license_expiry")
  passportNo      String?      @map("passport_no")
  
  // VEVO (Visa Verification)
  vevoStatus      VevoStatus   @default(PENDING) @map("vevo_status")
  vevoCheckedAt   DateTime?    @map("vevo_checked_at")
  
  // Driver Status
  status          DriverStatus @default(PENDING_APPROVAL)
  balance         Decimal      @default(0) @db.Decimal(10, 2)

  // Documents (paths to uploaded files)
  passportDoc     String?      @map("passport_doc")
  licenseDoc      String?      @map("license_doc")

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  user            User?        @relation(fields: [userId], references: [id])
  rentals         Rental[]

  @@map("drivers")
}

model Rental {
  id              String       @id @default(uuid())
  driverId        String       @map("driver_id")
  vehicleId       String       @map("vehicle_id")
  
  startDate       DateTime     @map("start_date")
  endDate         DateTime?    @map("end_date")
  
  bondAmount      Decimal      @db.Decimal(10, 2) @map("bond_amount")
  weeklyRate      Decimal      @db.Decimal(10, 2) @map("weekly_rate")
  
  nextPaymentDate DateTime     @map("next_payment_date")
  status          RentalStatus @default(ACTIVE)

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  driver          Driver       @relation(fields: [driverId], references: [id])
  vehicle         Vehicle      @relation(fields: [vehicleId], references: [id])
  invoices        Invoice[]

  @@map("rentals")
}

model Invoice {
  id              String        @id @default(uuid())
  rentalId        String        @map("rental_id")
  
  // Billing Formula: (Weekly_Rate + Tolls + Fines) - Credits
  weeklyRate      Decimal       @db.Decimal(10, 2) @map("weekly_rate")
  tolls           Decimal       @default(0) @db.Decimal(10, 2)
  fines           Decimal       @default(0) @db.Decimal(10, 2)
  credits         Decimal       @default(0) @db.Decimal(10, 2)
  amount          Decimal       @db.Decimal(10, 2) // Final calculated amount
  
  dueDate         DateTime      @map("due_date")
  paidAt          DateTime?     @map("paid_at")
  status          InvoiceStatus @default(PENDING)

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  rental          Rental        @relation(fields: [rentalId], references: [id])
  tollCharges     TollCharge[]

  @@map("invoices")
}

model TollCharge {
  id              String   @id @default(uuid())
  invoiceId       String?  @map("invoice_id")
  plate           String
  date            DateTime
  amount          Decimal  @db.Decimal(10, 2)
  location        String?
  
  createdAt       DateTime @default(now())

  invoice         Invoice? @relation(fields: [invoiceId], references: [id])

  @@map("toll_charges")
}

model Alert {
  id              String    @id @default(uuid())
  type            AlertType
  message         String
  vehicleId       String?   @map("vehicle_id")
  driverId        String?   @map("driver_id")
  resolved        Boolean   @default(false)
  resolvedAt      DateTime? @map("resolved_at")
  
  createdAt       DateTime  @default(now())

  vehicle         Vehicle?  @relation(fields: [vehicleId], references: [id])

  @@map("alerts")
}

model OnboardingToken {
  id              String   @id @default(uuid())
  token           String   @unique
  email           String
  expiresAt       DateTime @map("expires_at")
  used            Boolean  @default(false)
  usedAt          DateTime? @map("used_at")
  
  createdAt       DateTime @default(now())

  @@map("onboarding_tokens")
}

model EarningsRecord {
  id              String   @id @default(uuid())
  driverId        String   @map("driver_id")
  weekStarting    DateTime @map("week_starting")
  grossEarnings   Decimal  @db.Decimal(10, 2) @map("gross_earnings")
  netEarnings     Decimal  @db.Decimal(10, 2) @map("net_earnings")
  trips           Int
  platform        String   @default("uber") // uber, didi, ola
  
  createdAt       DateTime @default(now())

  @@unique([driverId, weekStarting, platform])
  @@map("earnings_records")
}

enum ShiftStatus {
  NOT_STARTED
  ACTIVE
  ENDED
}

model Shift {
  id              String      @id @default(uuid())
  rentalId        String      @map("rental_id")
  driverId        String      @map("driver_id")
  status          ShiftStatus @default(NOT_STARTED)
  startedAt       DateTime?   @map("started_at")
  endedAt         DateTime?   @map("ended_at")
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  conditionReport ConditionReport?

  @@map("shifts")
}

model ConditionReport {
  id              String   @id @default(uuid())
  shiftId         String   @unique @map("shift_id")
  vehicleId       String   @map("vehicle_id")
  driverId        String   @map("driver_id")
  
  // Damage markers as JSON array
  damageMarkers   String?  @map("damage_markers") // JSON: [{x, y, description, photo_url}]
  notes           String?
  photos          String[] // Array of photo URLs
  
  verifiedAt      DateTime @default(now()) @map("verified_at")
  createdAt       DateTime @default(now())

  shift           Shift    @relation(fields: [shiftId], references: [id])

  @@map("condition_reports")
}

model AccidentReport {
  id              String   @id @default(uuid())
  rentalId        String   @map("rental_id")
  driverId        String   @map("driver_id")
  vehicleId       String   @map("vehicle_id")
  
  // Step 1: Safety
  isSafe          Boolean  @default(true) @map("is_safe")
  emergencyCalled Boolean  @default(false) @map("emergency_called")
  
  // Step 2: Scene photos
  scenePhotos     String[] @map("scene_photos")
  
  // Step 3: Third party details
  thirdPartyName  String?  @map("third_party_name")
  thirdPartyPhone String?  @map("third_party_phone")
  thirdPartyPlate String?  @map("third_party_plate")
  thirdPartyInsurer String? @map("third_party_insurer")
  
  description     String?
  location        String?
  occurredAt      DateTime @map("occurred_at")
  
  // Offline sync
  syncedAt        DateTime? @map("synced_at")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("accident_reports")
}

